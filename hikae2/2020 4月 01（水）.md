---
Created: 2020-04-01T01:32
Updated: 2020-04-09T07:19
URL: https://diver.diveintocode.jp/curriculums/650
---
10:38

とうとうクライアント版のエバーノートでもおかしくなり始めた。新規作成したノートが反映されてない。

スマホ版、ブラウザ版では見られるから消えたわけではない。

ログアウトしても変化なし。ローカルキャッシュを消してみてはどうかと思ったが、探すのが面倒。

＞

ローカルのデータベースを削除し、再同期して回復。

新規作成したノート自体は、２０２０スタック以外のところにできていた。作成できなかったわけではなかった。

テスト

2020 4月 01（水）,01:32

---

- [ ] 課題を１つ終わらせる
- [x] Diverの就職タームの実技研修シリーズを読了する。できれば質問も評価文もつけて完了する

16:45 残り４３ページもある。こりゃ今日中は無理だわ。

参考図書を一通りイントロだけ触る

- [ ] わかりみSQL
- [ ] Rspec
- [ ] Rails４シルバー
- [ ] ERDレッスン
- [ ] 英文法の何故
- [ ] ４コマ英会話？
- [ ] ワークは、どうしようか？
- [x] 万葉課題のテキストに文句をつけて完了する
- [ ] Remindo最大限に消化
- [x] 渡邉氏の議事録を読んどく
- [ ] プロゲート、なにかひとつ

---

gem_cleaner って要る？仕様の機能になったのでは？

before ブロックの中に書けばit ごとにリセットされるのは分かったが。

＞

rails5.1, かつsystem specテストをするときだけ、database cleaner が自動になるらしい。

万葉課題のときは、実際、別のフォルダをさらに作ってもうひと手間のインストール手順があった。

エヌ1問題のパート、説明はいいが小題の位置が変

2020 4月 01（水）,11:35

---

```Plain
$ bundle binstub rspec-core
The dependency tzinfo-data (>= 0) will be unused by any of the platforms Bundler is installing for. Bundler is installing for ruby but the dependency is only for x86-mingw32, x86-mswin32, x64-mingw32, java. To add those platforms to the bundle, run `bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java`.
```

クエリの使い方１のテキスト。例題用のアプリを作ったが、Rspecのインストールをするコマンドで変なのが出た。

- -force のオプションの方でも同じメッセージ。

なくてもrspecは動いた。テキストの内容が古いのか？

いや、どうも俺のbundlerの環境がおかしいことに起因するようだ。github上でbundlerの公式にイシューが切られていたらしい。

面倒だから報告はパスでいいや。

count_titleAメソッドは、上記のようにインスタンスメソッドとして定義することもクラスメソッドとして定義することも可能です。

しかしcount_titleAメソッドは、Blogクラスをインスタンス化したもの（Blogsテーブルの中にある任意のレコード）に働きかけるものではなく、Blogクラスそのもの（Blogsテーブルのデータ全体）に対して処理するものです。

そのため、クラスメソッドとしてメソッドを実装するのが一般的です。

>クエリの使い方２

洗濯物とか見せたくないがためのZOOMの背景設定なのかな。

---

「クエリとは SQLの発行回数 のことです。」

ズバッと。

ブログに紐づくユーザの名前をusersテーブルから取得するコードなので、ユーザに紐づいているブログの個数分のクエリが発行されます。

- Blog.allのクエリ：1回
- blog.user.nameのクエリ：（ユーザに紐づいている）ブログの個数だけ発行されるのでN回

つまり合計のクエリ発行回数は N+1回 となります。

これを N+1問題 と言います。

N+1問題は当然ながらNの数字が大きければ大きいほど処理の速度に影響してきます。

N+1問題を解決するためには、取得したユーザとそれらに紐付く全てのブログをあらかじめ一発で取得することが必要です。

そのために使うのが includesメソッド です。

```Plain
@blogs = Blog.all.includes(:user)
```

～～

実行されるSQLは以下のように * がつきます。

この * こそ、速度を低下させる原因なのです。

---

```Plain
class Pitcher < ApplicationRecord
  # 省略
  def self.most_winners_in_team(year, team)
    pitchers = Pitcher.where(year_id: year, team_id: team)
    max_win = pitchers.maximum(:wins)
    best_pitchers = pitchers.where(wins: max_win)
  endend
```

しまった、.maximum(:wins) ここの:wins ってなんだっけ？

＞

最大の要素、もしくは最大の n 要素を返します。全要素が互いに <=> メソッドで比較できることを仮定しています。

引数を指定しない形式では要素が存在しなければ nil を返します。引数を指定する形式では、空の配列を返します。

Rubyリファレンス

投手のコスパを見るモデルのテスト。If文連打がややこしい。Diver、就職ターム、クエリの使い方８より

次に繰り返し処理の中身を定義していきます。

pitcherのwinsカラムの値(勝利数)をwinに代入します。

また、Salaryテーブルの全レコードから、処理中のpitcherに対応する給与レコードを取得し、salaryカラムの値をsalaryに代入します。

これでwin/salaryで費用対効果(cost_performance)を算出できるようになります。

cost_performanceよりwin/salaryが大きい場合と等しい場合に処理を分けます。

ここでは、to_fメソッドを使用してwin/salaryを小数として扱う必要があります。

cost_performanceよりwin/salaryが大きい場合、

新たに最大となった費用対効果(win/salary)をcost_performanceに代入します。

また、新たに最大となった費用対効果のpitcherをbest_pitchersにセットします。

一方cost_performanceとwin/salaryが等しい場合、

暫定最大の費用対効果と等しい費用対効果を持つpitcherをbest_pitchersに追加します。

最後にbest_pitchersからplayer_idカラムの値のみを配列として取得します。

(app/models/Pitcher.rb)

```Plain
class Pitcher < ApplicationRecord
  # 省略
  def self.best_deal(year)
    pitchers = Pitcher.where(year_id: year)
    cost_performance = 0
    best_pitchers = []
    pitchers.each do |pitcher|
      if Salary.exists?(year_id: year, player_id: pitcher.player_id)
        win = pitcher.wins
        salary = Salary.find_by(year_id: year, player_id: pitcher.player_id).salary
        if cost_performance < win/salary.to_f
          cost_performance = win/salary.to_f
          best_pitchers = [pitcher]
        elsif cost_performance == win/salary.to_f
          best_pitchers.push(pitcher)
        end
      end
    end
    best_pitchers.pluck(:player_id)
  end
end
```

---

やはりというか、環境系でトラブってぜんぜん課題が始められない。

```Plain
bin/webpack-dev-server
```

が走らない。エラーになる。

```Plain
ERROR in ./node_modules/css-loader??ref--2-2!./node_modules/postcss-loader/lib??ref--2-3!./node_modules/sass-loader/lib/loader.js??ref--2-4!./app/frontend/stylesheets/application.scss
Module build failed: Error: Node Sass does not yet support your current environment: OS X 64-bit with Unsupported runtime (72)
For more information on which environments are supported please see:
https://github.com/sass/node-sass/releases/tag/v4.9.0
```

最初はruby2.5.1が無いというもの。rails s が走らなかった。

rbenvの動きを調べ、バージョン指定で2.5.1をインストールした。

それでも動かないので、gem list rails を見るが、railsがまったくインストールされてない。

それで指定の2.5.0も入れる。

その後、rails s するとyarn が古いのでrails sができないという。関係あるのか？

ローカルには当然インストール済み。

とりあえずyarn install　するがエラーでビルド失敗。

無視するコマンドが提案されていたので

config/environments/development.rb

のファイルの中の、

```Plain
config.webpacker.check_yarn_integrity = false
```

をtrueから上記のようにfalseに変えた。これでrails sは起動する。

だが、その後のアプリケーション起動のための指示されたコマンドを入力すると、結局このwebpackerが原因でエラーになるようだ。

```Plain
Webpacker::Manifest::MissingEntryError at /users/sign_in
Webpacker can't find application.css in /Users/apple/workspace/diveintopost/public/packs/manifest.json. Possible causes:
1. You want to set webpacker.yml value of compile to true for your environment
  unless you are using the `webpack -w` or the webpack-dev-server.
2. webpack has not yet re-run to reflect updates.
3. You have misconfigured Webpacker's config/webpacker.yml file.
4. Your webpack configuration is not creating a manifest.
Your manifest contains:
{
  "application.js": "/packs/application-b3ab8b45c25c32b11a5c.js",
  "application.js.map": "/packs/application-b3ab8b45c25c32b11a5c.js.map"
}
```